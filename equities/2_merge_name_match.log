1                                                          The SAS System                        09:59 Wednesday, September 29, 2010

NOTE: Copyright (c) 2002-2008 by SAS Institute Inc., Cary, NC, USA. 
NOTE: SAS (r) Proprietary Software 9.2 (TS1M0) 
      Licensed to UNIVERSITY OF NORTH CAROLINA CHAPEL HILL - T&R, Site 0070084073.
NOTE: This session is executing on the Linux 2.6.18-194.el5 platform.



You are running SAS 9. Some SAS 8 files will be automatically converted 
by the V9 engine; others are incompatible.  Please see 
http://support.sas.com/rnd/migration/planning/platform/64bit.html

PROC MIGRATE will preserve current SAS file attributes and is 
recommended for converting all your SAS libraries from any 
SAS 8 release to SAS 9.  For details and examples, please see
http://support.sas.com/rnd/migration/index.html


This message is contained in the SAS news file, and is presented upon
initialization.  Edit the file "news" in the "misc/base" directory to
display site-specific news and information in the program log.
The command line option "-nonews" will prevent this display.




NOTE: SAS initialization used:
      real time           0.21 seconds
      cpu time            0.04 seconds
      
1          /* *************************************************************************/
2          /* CREATED BY:      Jesse Blocher (UNC-Chapel Hill)
3          /* MODIFIED BY:
4          /* DATE CREATED:    Sept 2010
5          /* PROG NAME:       eq_name_match.sas
6          /* Project:         Market Interconnectedness and Fires Sales, Momentum
7          /* This File:       Match the names with no cusips to names in CRSP
8          /************************************************************************************/
9          
10         %include 'marketnet_header.sas'; *header file with basic options and libraries;
NOTE: Libref MORN was successfully assigned as follows: 
      Engine:        V9 
      Physical Name: /largefs/jabloche/morningstar
NOTE: Libref MS_WORK was successfully assigned as follows: 
      Engine:        V9 
      Physical Name: /largefs/jabloche/ms_work
NOTE: Libref MKTNET was successfully assigned as follows: 
      Engine:        V9 
      Physical Name: /largefs/jabloche/marketnet
NOTE: Libref MKN_WORK was successfully assigned as follows: 
      Engine:        V9 
      Physical Name: /largefs/jabloche/marketnet_work
NOTE: Libref THOMSON was successfully assigned as follows: 
      Engine:        V9 
      Physical Name: /largefs/jabloche/thomson
23         
24         
25         /* Datasets required to run:
26          * mktnet.equities_raw				: Equities with no cusips; security cusip port_date fundid year
27          * mkn_work.cumulative&n			: where n = 1 to 317, which is the number of port_dates to
27       ! iterate
28          */
29         
30         /* Datasets Produced:
31          * mktnet.equities_matched			: name match data combined and appended to main dataset
32          * mktnet.equities_unmatched		: same data, still not yet matched to an NCUSIP
33          */
34         
35         %macro combine_matched_data(ds=,start=,finish=);
36         
37         data &ds;
38         	set mkn_work.cumulative1;
39         run;
40         
41         %do a=2=&start % to &finish ;
42         	proc append base = &ds data = mkn_work.cumulative&a ; run;
43         %end;
44         
45         %mend combine_matched_data;
46         
47         
48         ** First, we combine all the jobarray output datasets into one;
49         
50         *%combine_matched_data(ds=mkn_work.combined_matched_data,start=2,finish=317);
51         * NOTE: The data set MKN_WORK.COMBINED_MATCHED_DATA has 612365 observations and 14
51       ! variables;
52         
53         
54         
55         * should have identical columns but now cusip is updated;
56         data name_matched_data (drop = ncusip);
57         	set mkn_work.combined_matched_data (drop = comnam totalscore CompA CompB FirstLetterA
57       ! FirstLetterB NAMEDT NAMEENDT);
58         	cusip = ncusip;
59         run;

NOTE: There were 536974 observations read from the data set MKN_WORK.COMBINED_MATCHED_DATA.
NOTE: The data set WORK.NAME_MATCHED_DATA has 536974 observations and 6 variables.
NOTE: DATA statement used (Total process time):
      real time           26.14 seconds
      cpu time            0.52 seconds
      

60         
61         data equivalent_name_matched_data;
62         	set mkn_work.combined_matched_data (drop = comnam totalscore ncusip CompA CompB
62       ! FirstLetterA FirstLetterB NAMEDT NAMEENDT);
63         run;

NOTE: There were 536974 observations read from the data set MKN_WORK.COMBINED_MATCHED_DATA.
NOTE: The data set WORK.EQUIVALENT_NAME_MATCHED_DATA has 536974 observations and 6 variables.
NOTE: DATA statement used (Total process time):
      real time           26.27 seconds
      cpu time            0.54 seconds
      

64         
65         * should have identical columns and identical rows;
66         proc contents data = equivalent_name_matched_data; run;

NOTE: PROCEDURE CONTENTS used (Total process time):
      real time           0.91 seconds
      cpu time            0.02 seconds
      
NOTE: The PROCEDURE CONTENTS printed page 1.

67         proc contents data = mktnet.equities_raw; run;

NOTE: PROCEDURE CONTENTS used (Total process time):
      real time           0.11 seconds
      cpu time            0.01 seconds
      
NOTE: The PROCEDURE CONTENTS printed page 2.

68         
69         *check it - this should have same nobs as equities_raw because other is a subset;
70         proc sql;
71         	create table test_union as
72         	select * from mktnet.equities_raw
73         	UNION
74         	select * from equivalent_name_matched_data;
NOTE: Table WORK.TEST_UNION created, with 1020331 rows and 6 columns.

75         quit;
NOTE: PROCEDURE SQL used (Total process time):
      real time           26.45 seconds
      cpu time            3.93 seconds
      

76         
77         /* Dataset observation check:
78         1. Total non-valid cusip data:
79         NOTE: The data set MKN_WORK.EQUITIES_RAW has 1020331 observations and 6 variables.
80         now subdivided into name_matched_data and else
81         */
82         
83         *this gets the unmatched portion of the db but only works if whole row is identical;
84         proc sql;
85         	create table mktnet.equities_unmatched as
86         	select *
87         	from mktnet.equities_raw
88         	EXCEPT ALL
89         	select * from
90         	equivalent_name_matched_data;
NOTE: Table MKTNET.EQUITIES_UNMATCHED created, with 483367 rows and 6 columns.

91         quit;
NOTE: PROCEDURE SQL used (Total process time):
      real time           47.16 seconds
      cpu time            3.10 seconds
      

92         
93         /* Dataset observation check:
94         2. Combine matched data (now with CRSP-based cusips) together with existing good cusip
94       ! data
95         NOTE: The data set MKTNET.EQUITIES_VALID_CUSIP has 45696912 observations and 32
95       ! variables.
96         plus name_matched_data above
97         */
98         
99         
100        * need to merge pared down data with full holdings data by rowid;
101        * should have same NOBS as name_matched_data;
102        proc sql;
103        	CREATE TABLE mkn_work.full_data_added_cusip as
104        	SELECT 	a.rowid, a.fundid, a.port_date, a.port_year, b.cusip, a.type_cd, a.security,
104      ! a.shares, a.sharechange,
105        			a.marketvalue, a.weight, a.maturity, a.mat_year, a.coupon, a.type_name,
105      ! a.prv_port_date, a.num_holdings, a.tot_investment,
106        			a.eq_style_box, a.fi_style_box,
107        			a.pct_long_bond, a.pct_long_stock, a.pct_long_preferred, a.pct_long_convertible,
107      ! a.pct_long_cash, a.pct_long_other,
108        			a.pct_net_bond, a.pct_net_stock, a.pct_net_preferred, a.pct_net_convertible,
108      ! a.pct_net_cash, a.pct_net_other
109        	FROM mktnet.equities_no_cusip as a
110        	RIGHT JOIN
111        	name_matched_data as b
112        	ON a.rowid = b.rowid;
NOTE: Table MKN_WORK.FULL_DATA_ADDED_CUSIP created, with 536974 rows and 32 columns.

113        	
114        quit;
NOTE: PROCEDURE SQL used (Total process time):
      real time           53.47 seconds
      cpu time            2.95 seconds
      

115        
116        data mktnet.equities_matched;
117        	set mktnet.equities_valid_cusip;
118        run;

NOTE: There were 45696912 observations read from the data set MKTNET.EQUITIES_VALID_CUSIP.
NOTE: The data set MKTNET.EQUITIES_MATCHED has 45696912 observations and 32 variables.
NOTE: DATA statement used (Total process time):
      real time           15:02.28
      cpu time            37.79 seconds
      

119        
120        proc append base = mktnet.equities_matched data = mkn_work.full_data_added_cusip; run;

NOTE: Appending MKN_WORK.FULL_DATA_ADDED_CUSIP to MKTNET.EQUITIES_MATCHED.
NOTE: There were 536974 observations read from the data set MKN_WORK.FULL_DATA_ADDED_CUSIP.
NOTE: 536974 observations added.
NOTE: The data set MKTNET.EQUITIES_MATCHED has 46233886 observations and 32 variables.
NOTE: PROCEDURE APPEND used (Total process time):
      real time           22.23 seconds
      cpu time            0.44 seconds
      

NOTE: SAS Institute Inc., SAS Campus Drive, Cary, NC USA 27513-2414
NOTE: The SAS System used:
      real time           18:26.35
      cpu time            49.35 seconds
      
